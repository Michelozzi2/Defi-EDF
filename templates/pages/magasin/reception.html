{% extends "base.html" %}

{% block title %}R√©ception Cartons - EDF Tracker{% endblock %}
{% block page_title %}üì¶ R√©ception Cartons{% endblock %}

{% block content %}
<div class="max-w-lg mx-auto" x-data="receptionForm()">
    <!-- Search card -->
    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
        <h2 class="text-lg font-semibold text-slate-800 mb-4">Rechercher un carton</h2>
        
        <div class="space-y-4">
            <div>
                <label for="num_carton" class="block text-sm font-medium text-slate-600 mb-2">
                    N¬∞ Carton
                </label>
                <input type="text" 
                       id="num_carton"
                       x-model="numCarton"
                       @keyup.enter="search()"
                       class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-edf-blue focus:border-transparent transition-all"
                       placeholder="Ex: CB71B1147852">
            </div>
            
            <button @click="search()"
                    :disabled="!numCarton || loading"
                    class="w-full py-3 px-4 bg-edf-blue hover:bg-edf-blue-light text-white font-medium rounded-xl transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2">
                <svg x-show="loading" class="animate-spin w-5 h-5" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <svg x-show="!loading" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                </svg>
                <span x-text="loading ? 'Recherche...' : 'Rechercher'"></span>
            </button>
        </div>
    </div>
    
    <!-- Carton info with concentrators -->
    <div x-show="carton" x-cloak class="mt-6">
        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
            <div class="flex items-start justify-between mb-4">
                <h3 class="text-lg font-semibold text-slate-800" x-text="carton?.num_carton"></h3>
                <span class="px-3 py-1 text-sm font-medium rounded-full"
                      :class="carton?.nb_en_livraison > 0 ? 'bg-amber-100 text-amber-700' : 'bg-emerald-100 text-emerald-700'"
                      x-text="carton?.nb_en_livraison > 0 ? 'En livraison' : 'R√©ceptionn√©'"></span>
            </div>
            
            <div class="space-y-3 text-sm">
                <div class="flex justify-between py-2 border-b border-slate-100">
                    <span class="text-slate-500">Op√©rateur</span>
                    <span class="font-medium text-slate-800" x-text="carton?.operateur"></span>
                </div>
                <div class="flex justify-between py-2 border-b border-slate-100">
                    <span class="text-slate-500">Total concentrateurs</span>
                    <span class="font-medium text-slate-800" x-text="carton?.nb_total"></span>
                </div>
            </div>
            
            <!-- Status breakdown -->
            <div class="mt-4 p-4 bg-slate-50 rounded-xl">
                <p class="text-sm font-medium text-slate-700 mb-3">R√©partition par √©tat :</p>
                <div class="grid grid-cols-2 gap-2 text-sm">
                    <div class="flex items-center justify-between p-2 bg-white rounded-lg" x-show="carton?.nb_en_livraison > 0">
                        <span class="flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full bg-amber-500"></span>
                            En livraison
                        </span>
                        <span class="font-bold text-amber-600" x-text="carton?.nb_en_livraison"></span>
                    </div>
                    <div class="flex items-center justify-between p-2 bg-white rounded-lg" x-show="carton?.nb_en_stock > 0">
                        <span class="flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full bg-emerald-500"></span>
                            En stock
                        </span>
                        <span class="font-bold text-emerald-600" x-text="carton?.nb_en_stock"></span>
                    </div>
                    <div class="flex items-center justify-between p-2 bg-white rounded-lg" x-show="carton?.nb_pose > 0">
                        <span class="flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full bg-blue-500"></span>
                            Pos√©
                        </span>
                        <span class="font-bold text-blue-600" x-text="carton?.nb_pose"></span>
                    </div>
                    <div class="flex items-center justify-between p-2 bg-white rounded-lg" x-show="carton?.nb_a_tester > 0">
                        <span class="flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full bg-orange-500"></span>
                            √Ä tester
                        </span>
                        <span class="font-bold text-orange-600" x-text="carton?.nb_a_tester"></span>
                    </div>
                    <div class="flex items-center justify-between p-2 bg-white rounded-lg" x-show="carton?.nb_hs > 0">
                        <span class="flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full bg-red-500"></span>
                            HS
                        </span>
                        <span class="font-bold text-red-600" x-text="carton?.nb_hs"></span>
                    </div>
                </div>
            </div>
            
            <button x-show="carton?.nb_en_livraison > 0"
                    @click="validerReception()"
                    :disabled="submitting"
                    class="w-full mt-6 py-3.5 px-4 bg-emerald-500 hover:bg-emerald-600 text-white font-semibold rounded-xl transition-all disabled:opacity-50 flex items-center justify-center gap-2 shadow-lg shadow-emerald-500/30">
                <svg x-show="submitting" class="animate-spin w-5 h-5" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <svg x-show="!submitting" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                </svg>
                <span x-text="submitting ? 'Validation...' : `R√©ceptionner ${carton?.nb_en_livraison} concentrateur(s)`"></span>
            </button>
            
            <div x-show="carton?.nb_en_livraison === 0" class="mt-4 p-4 bg-emerald-50 rounded-xl text-center">
                <p class="text-emerald-700">‚úì Tous les concentrateurs de ce carton sont d√©j√† r√©ceptionn√©s</p>
            </div>
        </div>
    </div>
    
    <!-- Success result -->
    <div x-show="result" x-cloak class="mt-6">
        <div class="bg-emerald-50 border border-emerald-200 rounded-2xl p-6">
            <div class="flex items-center gap-3 mb-4">
                <div class="w-10 h-10 bg-emerald-500 rounded-full flex items-center justify-center">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                    </svg>
                </div>
                <h3 class="text-lg font-semibold text-emerald-800">R√©ception valid√©e</h3>
            </div>
            <p class="text-emerald-700">
                <span x-text="result?.nb_recus"></span> concentrateur(s) r√©ceptionn√©(s) depuis le carton <span x-text="result?.carton" class="font-semibold"></span>.
            </p>
        </div>
    </div>
</div>

<script>
function receptionForm() {
    return {
        numCarton: '',
        carton: null,
        loading: false,
        submitting: false,
        result: null,
        
        async search() {
            if (!this.numCarton) return;
            
            this.loading = true;
            this.carton = null;
            this.result = null;
            
            try {
                // Get carton info
                const cartonResp = await fetch(`/api/v1/cartons/?search=${encodeURIComponent(this.numCarton)}`);
                const cartonData = await cartonResp.json();
                
                if (!cartonData.results || cartonData.results.length === 0) {
                    window.dispatchEvent(new CustomEvent('notify', {
                        detail: { message: 'Carton non trouv√©', type: 'error' }
                    }));
                    this.loading = false;
                    return;
                }
                
                const c = cartonData.results[0];
                
                // Get concentrators status for this carton
                const kResp = await fetch(`/api/v1/concentrateurs/?search=${encodeURIComponent(c.num_carton)}&page_size=200`);
                const kData = await kResp.json();
                
                const concentrateurs = kData.results || [];
                
                // Count by status
                const counts = {
                    en_livraison: 0,
                    en_stock: 0,
                    pose: 0,
                    a_tester: 0,
                    HS: 0
                };
                
                concentrateurs.forEach(k => {
                    if (counts.hasOwnProperty(k.etat)) {
                        counts[k.etat]++;
                    }
                });
                
                this.carton = {
                    num_carton: c.num_carton,
                    operateur: c.operateur,
                    nb_total: concentrateurs.length,
                    nb_en_livraison: counts.en_livraison,
                    nb_en_stock: counts.en_stock,
                    nb_pose: counts.pose,
                    nb_a_tester: counts.a_tester,
                    nb_hs: counts.HS
                };
            } catch (e) {
                window.dispatchEvent(new CustomEvent('notify', {
                    detail: { message: 'Erreur de recherche', type: 'error' }
                }));
            }
            
            this.loading = false;
        },
        
        async validerReception() {
            if (!this.carton) return;
            
            this.submitting = true;
            
            try {
                const response = await fetch('/api/v1/actions/reception/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
                    },
                    body: JSON.stringify({ num_carton: this.carton.num_carton })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    this.result = data;
                    this.carton = null;
                    window.dispatchEvent(new CustomEvent('notify', {
                        detail: { message: `${data.nb_recus} concentrateur(s) r√©ceptionn√©(s)`, type: 'success' }
                    }));
                } else {
                    const error = await response.json();
                    window.dispatchEvent(new CustomEvent('notify', {
                        detail: { message: error.error || 'Erreur', type: 'error' }
                    }));
                }
            } catch (e) {
                window.dispatchEvent(new CustomEvent('notify', {
                    detail: { message: 'Erreur de connexion', type: 'error' }
                }));
            }
            
            this.submitting = false;
        }
    }
}
</script>
{% endblock %}
