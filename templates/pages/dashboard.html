{% extends "base.html" %}

{% block title %}Dashboard - EDF Tracker{% endblock %}
{% block page_title %}ðŸ“Š Supervision Stocks{% endblock %}

{% block content %}
<div x-data="dashboard()" x-init="loadStats()">
    <!-- Stats cards -->
    <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-4 mb-8">
        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-4">
            <p class="text-sm text-slate-500 mb-1">Total</p>
            <p class="text-2xl font-bold text-slate-800" x-text="stats.total || '-'"></p>
        </div>
        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-4">
            <p class="text-sm text-slate-500 mb-1">En stock</p>
            <p class="text-2xl font-bold text-emerald-600" x-text="stats.by_etat?.en_stock || 0"></p>
        </div>
        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-4">
            <p class="text-sm text-slate-500 mb-1">PosÃ©s</p>
            <p class="text-2xl font-bold text-edf-blue" x-text="stats.by_etat?.pose || 0"></p>
        </div>
        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-4">
            <p class="text-sm text-slate-500 mb-1">En livraison</p>
            <p class="text-2xl font-bold text-amber-600" x-text="stats.by_etat?.en_livraison || 0"></p>
        </div>
        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-4">
            <p class="text-sm text-slate-500 mb-1">HS</p>
            <p class="text-2xl font-bold text-red-600" x-text="stats.by_etat?.HS || 0"></p>
        </div>
    </div>

    <!-- Charts -->
    <div class="grid lg:grid-cols-2 gap-6 mb-8">
        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
            <h3 class="text-lg font-semibold text-slate-800 mb-4">Par Ã‰tat</h3>
            <canvas id="chartEtat" class="w-full" height="250"></canvas>
        </div>
        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
            <h3 class="text-lg font-semibold text-slate-800 mb-4">Par Affectation</h3>
            <canvas id="chartAffectation" class="w-full" height="250"></canvas>
        </div>
    </div>

    <!-- Search/list -->
    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
        <div class="flex flex-col sm:flex-row gap-4 mb-6">
            <div class="flex-1">
                <input type="text" x-model="searchQuery" @keyup.enter="searchConcentrateurs()"
                    placeholder="Rechercher par NÂ° sÃ©rie..."
                    class="w-full px-4 py-2.5 border border-slate-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-edf-blue focus:border-transparent">
            </div>
            <select x-model="filterEtat" @change="searchConcentrateurs()"
                class="px-4 py-2.5 border border-slate-300 rounded-xl bg-white focus:outline-none focus:ring-2 focus:ring-edf-blue">
                <option value="">Tous Ã©tats</option>
                <option value="en_livraison">En livraison</option>
                <option value="en_stock">En stock</option>
                <option value="pose">PosÃ©</option>
                <option value="a_tester">Ã€ tester</option>
                <option value="en_attente_recond">En attente recond.</option>
                <option value="HS">HS</option>
            </select>
            <select x-model="filterAffectation" @change="searchConcentrateurs()"
                class="px-4 py-2.5 border border-slate-300 rounded-xl bg-white focus:outline-none focus:ring-2 focus:ring-edf-blue">
                <option value="">Toutes affectations</option>
                <option value="Magasin">Magasin</option>
                <option value="BO Nord">BO Nord</option>
                <option value="BO Centre">BO Centre</option>
                <option value="BO Sud">BO Sud</option>
                <option value="Labo">Labo</option>
            </select>
            <button @click="searchConcentrateurs()"
                class="px-6 py-2.5 bg-edf-blue hover:bg-edf-blue-light text-white rounded-xl transition-colors">
                Filtrer
            </button>
        </div>

        <!-- Table -->
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead>
                    <tr class="border-b border-slate-200">
                        <th class="text-left py-3 px-2 text-sm font-medium text-slate-600">NÂ° SÃ©rie</th>
                        <th class="text-left py-3 px-2 text-sm font-medium text-slate-600">Carton</th>
                        <th class="text-left py-3 px-2 text-sm font-medium text-slate-600">Ã‰tat</th>
                        <th class="text-left py-3 px-2 text-sm font-medium text-slate-600">Affectation</th>
                        <th class="text-left py-3 px-2 text-sm font-medium text-slate-600">Date</th>
                    </tr>
                </thead>
                <tbody>
                    <template x-for="k in concentrateurs" :key="k.n_serie">
                        <tr class="border-b border-slate-100 hover:bg-slate-50 cursor-pointer"
                            @click="window.location.href = '/concentrateur/' + k.n_serie + '/'">
                            <td class="py-3 px-2 font-mono font-medium text-slate-800" x-text="k.n_serie"></td>
                            <td class="py-3 px-2 text-slate-600" x-text="k.carton_num || '-'"></td>
                            <td class="py-3 px-2">
                                <span class="px-2 py-1 text-xs font-medium rounded-full" :class="{
                                          'bg-emerald-100 text-emerald-700': k.etat === 'en_stock',
                                          'bg-blue-100 text-blue-700': k.etat === 'pose',
                                          'bg-amber-100 text-amber-700': k.etat === 'en_livraison' || k.etat === 'a_tester',
                                          'bg-purple-100 text-purple-700': k.etat === 'en_attente_recond',
                                          'bg-red-100 text-red-700': k.etat === 'HS'
                                      }" x-text="k.etat_display"></span>
                            </td>
                            <td class="py-3 px-2 text-slate-600" x-text="k.affectation || '-'"></td>
                            <td class="py-3 px-2 text-slate-500 text-sm" x-text="k.date_dernier_etat"></td>
                        </tr>
                    </template>
                    <tr x-show="concentrateurs.length === 0">
                        <td colspan="5" class="py-8 text-center text-slate-500">Aucun rÃ©sultat</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    function dashboard() {
        return {
            stats: {},
            concentrateurs: [],
            searchQuery: '',
            filterEtat: '',
            filterAffectation: '',
            chartEtat: null,
            chartAffectation: null,

            async loadStats() {
                try {
                    const response = await fetch('/api/v1/dashboard/stocks/');
                    this.stats = await response.json();
                    this.renderCharts();
                    this.searchConcentrateurs();
                } catch (e) {
                    console.error('Failed to load stats', e);
                }
            },

            renderCharts() {
                // Ã‰tat chart
                const ctxEtat = document.getElementById('chartEtat').getContext('2d');
                if (this.chartEtat) this.chartEtat.destroy();
                this.chartEtat = new Chart(ctxEtat, {
                    type: 'doughnut',
                    data: {
                        labels: ['En stock', 'PosÃ©', 'En livraison', 'Ã€ tester', 'HS'],
                        datasets: [{
                            data: [
                                this.stats.by_etat?.en_stock || 0,
                                this.stats.by_etat?.pose || 0,
                                this.stats.by_etat?.en_livraison || 0,
                                this.stats.by_etat?.a_tester || 0,
                                this.stats.by_etat?.HS || 0
                            ],
                            backgroundColor: ['#10b981', '#004A99', '#f59e0b', '#f97316', '#ef4444']
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { position: 'bottom' } }
                    }
                });

                // Affectation chart
                const ctxAff = document.getElementById('chartAffectation').getContext('2d');
                if (this.chartAffectation) this.chartAffectation.destroy();
                this.chartAffectation = new Chart(ctxAff, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(this.stats.by_affectation || {}),
                        datasets: [{
                            label: 'Concentrateurs',
                            data: Object.values(this.stats.by_affectation || {}),
                            backgroundColor: '#004A99'
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { display: false } },
                        scales: { y: { beginAtZero: true } }
                    }
                });
            },

            async searchConcentrateurs() {
                let url = '/api/v1/concentrateurs/?';
                const params = new URLSearchParams();

                if (this.searchQuery) params.append('search', this.searchQuery);
                if (this.filterEtat) params.append('etat', this.filterEtat);
                if (this.filterAffectation) params.append('affectation', this.filterAffectation);

                try {
                    const response = await fetch(url + params.toString());
                    const data = await response.json();
                    this.concentrateurs = data.results || [];
                } catch (e) {
                    console.error('Search failed', e);
                }
            }
        }
    }
</script>
{% endblock %}